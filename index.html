<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ariya charge % calculator</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="EV % Calc">
<meta name="theme-color" content="#ffffff">
<meta name="color-scheme" content="light dark">

<style>
  :root { --pad:14px; --radius:12px; --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
  html { -webkit-text-size-adjust: 100%; }
  body { font-family: var(--font); margin:0; padding:0; background:#f6f7f9; color:#0f172a; }
  .wrap { max-width:680px; margin:40px auto; padding:0 var(--pad); }
  .card { position:relative; background:#fff; border-radius:var(--radius); box-shadow:0 1px 3px rgba(0,0,0,.08),0 10px 24px rgba(0,0,0,.06); padding:calc(var(--pad)*1.25); transition:background .2s,color .2s,border-color .2s; }
  .card.danger { background:#b91c1c; color:#fff; }
  h1 { font-size:1.25rem; margin:0; }

  .topbar { display:flex; justify-content:flex-start; margin:6px 0 12px; }
  .btn { border:1px solid #cbd5e1; background:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
  .btn:active { transform: translateY(1px); }

  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:10px 0 6px; }
  label { display:block; font-weight:600; font-size:.9rem; margin-bottom:6px; }
  input[type="number"]{
    width:100%; font-size:16px; padding:6px 8px;
    border:1px solid #cbd5e1; border-radius:6px; outline:none;
    background:#fff; color:#0f172a; -webkit-appearance:none; appearance:none;
  }
  .card.danger input[type="number"]{ background:#fee2e2; border-color:#fecaca; color:#7f1d1d; }
  input[type="number"]:focus{ border-color:#64748b; }
  .muted{ color:#64748b; font-size:.9rem; }
  .card.danger .muted{ color:#fde68a; }

  .result{ margin-top:18px; padding:18px; background:#f1f5f9; border-radius:12px; text-align:center; }
  .card.danger .result{ background:rgba(255,255,255,.12); }
  .result .big{ font-size:2rem; line-height:1.2; }
  .result .big strong{ font-weight:800; }
  .warn{ margin-top:8px; font-size:.95rem; text-align:center; display:none; }
  .card.danger .warn{ display:block; font-weight:700; }

  /* Desktop */
  @media (min-width:768px){ input[type="number"]{ max-width:140px; display:inline-block; } }

  /* Tic-Tac-Toe */
  .ttt { margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; }
  .card.danger .ttt { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.25); }
  .ttt h2 { margin:0 0 6px; font-size:1rem; }
  .ttt .note { margin:0 0 10px; font-size:.9rem; color:#475569; }
  .card.danger .ttt .note { color:#fde68a; }
  .board { display:grid; grid-template-columns:repeat(3, 64px); grid-template-rows:repeat(3, 64px); gap:6px; justify-content:center; margin:10px 0; }
  .cell {
    width:64px; height:64px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
    font-size:1.5rem; font-weight:800; color:#111; display:flex; align-items:center; justify-content:center;
    cursor:pointer; user-select:none;
  }
  .cell:active { transform: translateY(1px); }
  .card.danger .cell { background:#fff; color:#111; }
  .ttt-controls { display:flex; gap:10px; justify-content:center; align-items:center; margin-top:6px; flex-wrap:wrap; }
  .status { text-align:center; margin-top:6px; font-weight:600; }

  /* Select visibility fix */
  select { padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; color:#111; font-size:0.9rem; }
  .card.danger select { background:#fff; color:#111; }

  /* Doodle Pad */
  .doodle { margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; }
  .card.danger .doodle { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.25); }
  .doodle h2 { margin:0 0 6px; font-size:1rem; }
  .doodle .note { margin:0 0 10px; font-size:.9rem; color:#475569; }
  .card.danger .doodle .note { color:#fde68a; }
  .doodle-controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:8px; }
  .doodle-controls input[type="color"], .doodle-controls input[type="range"] { cursor:pointer; }
  .doodle-canvas-wrap { display:flex; justify-content:center; }
  canvas { background:#fff; border:1px solid #e2e8f0; border-radius:10px; touch-action:none; }

  /* Fireworks canvas overlay */
  .fx-canvas {
    position: fixed; inset: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 9999; display: none;
  }
  @media (prefers-reduced-motion: reduce) {
    .fx-canvas { display:none !important; }
  }
</style>
</head>
<body>
  <canvas id="fx" class="fx-canvas"></canvas>

  <div class="wrap">
    <div class="card" id="card">
      <h1>Ariya Charge % Calculator</h1>

      <div class="topbar">
        <button class="btn" id="swapBtn" aria-pressed="false" title="Swap input/output">Swap: miles → %</button>
      </div>

      <div class="grid">
        <div>
          <label for="miles" id="milesLabel">Trip distance (miles)</label>
          <input type="number" id="miles" placeholder="e.g., 120" min="0" step="1" inputmode="numeric">
        </div>
        <div>
          <label for="buffer">Arrival range (miles)</label>
          <input type="number" id="buffer" value="10" min="0" step="1" inputmode="numeric">
          <div class="muted">Recommended minimum: 10 miles.</div>
        </div>
      </div>

      <div class="result" id="out" aria-live="polite">
        <span class="big" id="forwardText">Charge to <strong id="pct">--%</strong></span>
        <span class="big" id="reverseText" style="display:none;">Plan for ~<strong id="milesOut">--</strong> miles</span>
        <div class="warn" id="cap">Unable to make trip at 100%.</div>
      </div>

      <!-- Tic-Tac-Toe -->
      <div class="ttt">
        <h2>Tic-Tac-Toe</h2>
        <div class="note">Play tic-tac-toe while charging if you’re bored.</div>
        <div class="board" id="board" aria-label="Tic Tac Toe board"></div>
        <div class="status" id="ttt-status">X to move</div>
        <div class="ttt-controls">
          <button class="btn" id="ttt-new">New Game</button>
          <label class="inline" style="gap:6px;">
            <input type="checkbox" id="ttt-vsai" checked> Check box to play against phone
          </label>
          <label class="inline" style="gap:6px;">
            Difficulty:
            <select id="ttt-diff">
              <option value="easy">Easy</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">Hard</option>
              <option value="unbeatable">Unbeatable</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Doodle Pad -->
      <div class="doodle">
        <h2>Doodle Pad</h2>
        <div class="note">Make a little art while you charge.</div>
        <div class="doodle-controls">
          <label>Color <input type="color" id="drawColor" value="#111111"></label>
          <label>Size <input type="range" id="drawSize" min="1" max="24" value="6"></label>
          <button class="btn" id="undoDraw">Undo</button>
          <button class="btn" id="clearDraw">Clear</button>
          <button class="btn" id="saveDraw">Save PNG</button>
        </div>
        <div class="doodle-canvas-wrap">
          <canvas id="drawCanvas" width="320" height="240"></canvas>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  // ===== Calculator with swap (EFF hard-locked to 2.25) =====
  const EFF = 2.25; // conservative miles per 1%

  const miles  = document.getElementById('miles');
  const milesLabel = document.getElementById('milesLabel');
  const buffer = document.getElementById('buffer');
  const pctOut = document.getElementById('pct');
  const milesOut = document.getElementById('milesOut');
  const card   = document.getElementById('card');
  const cap    = document.getElementById('cap');
  const swapBtn= document.getElementById('swapBtn');
  const forwardText = document.getElementById('forwardText');
  const reverseText = document.getElementById('reverseText');

  const saved = JSON.parse(localStorage.getItem('ariyacalc') || '{}');
  if (saved.miles  != null) miles.value  = saved.miles;
  if (saved.buffer != null) buffer.value = saved.buffer; else buffer.value = 10;

  let reverse = saved.mode === 'reverse';
  updateModeUI();

  function compute(){
    const buf = Number(buffer.value || 0);

    localStorage.setItem('ariyacalc', JSON.stringify({
      miles: miles.value === "" ? "" : Number(miles.value),
      buffer: buf,
      mode: reverse ? 'reverse' : 'forward'
    }));

    if (!reverse){
      const m = (miles.value === "" ? NaN : Number(miles.value));
      if (isNaN(m)) {
        pctOut.textContent = "--%";
        card.classList.remove('danger'); cap.style.display = "none";
        return;
      }
      let pct = (m + buf) / EFF;
      pct = Math.ceil(pct);
      const exceeds = pct > 100;
      pctOut.textContent = pct + "%";
      if (exceeds) { card.classList.add('danger'); cap.style.display = "block"; }
      else { card.classList.remove('danger'); cap.style.display = "none"; }
    } else {
      const p = (miles.value === "" ? NaN : Number(miles.value));
      if (isNaN(p)) {
        milesOut.textContent = "--";
        card.classList.remove('danger'); cap.style.display = "none";
        return;
      }
      const mOut = Math.max(0, Math.floor((p * EFF) - buf));
      milesOut.textContent = mOut;
      card.classList.remove('danger'); cap.style.display = "none";
    }
  }

  function updateModeUI(){
    if (!reverse){
      swapBtn.textContent = "Swap: miles → %";
      swapBtn.setAttribute('aria-pressed', 'false');
      milesLabel.textContent = "Trip distance (miles)";
      miles.placeholder = "e.g., 120";
      forwardText.style.display = "";
      reverseText.style.display = "none";
    } else {
      swapBtn.textContent = "Swap: % → miles";
      swapBtn.setAttribute('aria-pressed', 'true');
      milesLabel.textContent = "Charge % available";
      miles.placeholder = "e.g., 65";
      forwardText.style.display = "none";
      reverseText.style.display = "";
    }
    compute();
  }

  swapBtn.addEventListener('click', () => { reverse = !reverse; updateModeUI(); });
  [miles, buffer].forEach(el => el.addEventListener('input', compute));
  compute();

  // ===== Fireworks system =====
  const fxCanvas = document.getElementById('fx');
  const mqlReduce = window.matchMedia('(prefers-reduced-motion: reduce)');
  let fxCtx, fxW, fxH, fxRAF = null, fxParticles = [], fxActive = false, fxEndTime = 0;

  function fxResize(){
    if (!fxCanvas) return;
    const dpr = window.devicePixelRatio || 1;
    fxCanvas.width = Math.floor(window.innerWidth * dpr);
    fxCanvas.height = Math.floor(window.innerHeight * dpr);
    fxCanvas.style.width = window.innerWidth + 'px';
    fxCanvas.style.height = window.innerHeight + 'px';
    fxCtx = fxCanvas.getContext('2d');
    fxCtx.setTransform(dpr,0,0,dpr,0,0);
    fxW = window.innerWidth; fxH = window.innerHeight;
  }
  window.addEventListener('resize', fxResize);
  fxResize();

  function spawnBurst(x, y, colors){
    const count = 80;
    for (let i=0;i<count;i++){
      const angle = (Math.PI * 2) * (i / count) + (Math.random()*0.2);
      const speed = 2 + Math.random()*3.5;
      fxParticles.push({
        x, y,
        vx: Math.cos(angle)*speed,
        vy: Math.sin(angle)*speed - (Math.random()*1.0),
        life: 60 + Math.random()*30,
        age: 0,
        r: 2 + Math.random()*2.5,
        color: colors[i % colors.length]
      });
    }
  }

  function fxLoop(){
    if (!fxActive){ fxCanvas.style.display = 'none'; return; }
    fxCanvas.style.display = 'block';
    fxCtx.clearRect(0,0,fxW,fxH);

    for (let i=fxParticles.length-1;i>=0;i--){
      const p = fxParticles[i];
      p.age++;
      if (p.age > p.life){ fxParticles.splice(i,1); continue; }
      p.vy += 0.04; p.vx *= 0.99; p.vy *= 0.99;
      p.x += p.vx; p.y += p.vy;

      const t = 1 - (p.age / p.life);
      fxCtx.globalAlpha = Math.max(0, t);
      fxCtx.beginPath();
      fxCtx.fillStyle = p.color;
      fxCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      fxCtx.fill();
      fxCtx.globalAlpha = 1;
    }

    if (Date.now() > fxEndTime && fxParticles.length === 0){
      fxActive = false; fxCanvas.style.display = 'none'; fxRAF = null; return;
    }
    fxRAF = requestAnimationFrame(fxLoop);
  }

  function launchFireworks(anchorEl){
    if (mqlReduce.matches) return;
    try{ if (navigator.vibrate) navigator.vibrate(60); }catch(e){}
    fxResize();
    const rect = anchorEl ? anchorEl.getBoundingClientRect() : {left:0, top:0, width:fxW, height:fxH};
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2 + window.scrollY;
    const palettes = [
      ['#ff4757','#ffa502','#ff6b81','#ffdd59'],
      ['#1e90ff','#70a1ff','#2ed573','#7bed9f'],
      ['#a55eea','#fd79a8','#e84393','#fab1a0']
    ];
    spawnBurst(cx, cy, palettes[0]);
    spawnBurst(cx - 80, cy - 60, palettes[1]);
    spawnBurst(cx + 90, cy - 90, palettes[2]);

    fxActive = true;
    fxEndTime = Date.now() + 2000;
    if (!fxRAF) fxLoop();
  }

  // ===== Tic-Tac-Toe with difficulty & fireworks =====
  const boardEl  = document.getElementById('board');
  const statusEl = document.getElementById('ttt-status');
  const newBtn   = document.getElementById('ttt-new');
  const vsAi     = document.getElementById('ttt-vsai');
  const diffSel  = document.getElementById('ttt-diff');

  let board = Array(9).fill(null);
  let turn = 'X';
  let gameOver = false;

  const lines = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  function renderBoard(){
    boardEl.innerHTML = '';
    board.forEach((val, i) => {
      const btn = document.createElement('button');
      btn.className = 'cell';
      btn.setAttribute('aria-label', `Cell ${i+1}`);
      btn.textContent = val ? val : '';
      btn.disabled = !!val || gameOver;
      btn.addEventListener('click', () => move(i));
      boardEl.appendChild(btn);
    });
  }

  function winner(b){
    for (const [a,c,d] of lines){
      if (b[a] && b[a] === b[c] && b[a] === b[d]) return {player:b[a], line:[a,c,d]};
    }
    return null;
  }

  function empties(b){ return b.map((v,i)=>v?null:i).filter(i=>i!==null); }

  function minimax(b, player){
    const w = winner(b);
    if (w && w.player === 'O') return {score: +1};
    if (w && w.player === 'X') return {score: -1};
    if (empties(b).length === 0) return {score: 0};

    if (player === 'O'){
      let best = {score: -Infinity, move: null};
      for (const i of empties(b)){
        const copy = b.slice(); copy[i] = 'O';
        const res = minimax(copy, 'X');
        if (res.score > best.score) best = {score: res.score, move: i};
      }
      return best;
    } else {
      let best = {score: +Infinity, move: null};
      for (const i of empties(b)){
        const copy = b.slice(); copy[i] = 'X';
        const res = minimax(copy, 'O');
        if (res.score < best.score) best = {score: res.score, move: i};
      }
      return best;
    }
  }

  function heuristicMove(){
    const me='O', opp='X';
    const e = empties(board);
    for (const i of e){ const t=board.slice(); t[i]=me; if ((winner(t)||{}).player===me) return i; }
    for (const i of e){ const t=board.slice(); t[i]=opp; if ((winner(t)||{}).player===opp) return i; }
    if (board[4]==null) return 4;
    const corners=[0,2,6,8].filter(i=>board[i]==null);
    if (corners.length) return corners[Math.floor(Math.random()*corners.length)];
    return e[Math.floor(Math.random()*e.length)];
  }

  function aiMove(){
    const difficulty = diffSel.value;
    const e = empties(board);
    if (e.length===0) return;

    const blunderRates = { easy: 0.5, normal: 0.2, hard: 0.05, unbeatable: 0 };
    const blunder = Math.random() < blunderRates[difficulty];

    let moveIndex;
    if (difficulty === 'unbeatable' || !blunder){
      moveIndex = minimax(board, 'O').move;
      if (moveIndex == null) moveIndex = heuristicMove();
    } else {
      moveIndex = e[Math.floor(Math.random()*e.length)];
    }
    if (moveIndex != null) move(moveIndex);
  }

  function move(i){
    if (gameOver || board[i]) return;
    board[i] = turn;

    const w = winner(board);
    if (w){
      statusEl.textContent = `${w.player} wins!`;
      gameOver = true;
      renderBoard();
      launchFireworks(boardEl); // celebrate!
      return;
    }
    if (empties(board).length === 0){
      statusEl.textContent = `It's a draw.`;
      gameOver = true;
      renderBoard();
      return;
    }

    turn = (turn === 'X') ? 'O' : 'X';
    statusEl.textContent = `${turn} to move`;
    renderBoard();

    if (!gameOver && vsAi.checked && turn === 'O'){
      setTimeout(aiMove, 220);
    }
  }

  function resetGame(){
    board = Array(9).fill(null);
    turn = 'X';
    gameOver = false;
    statusEl.textContent = 'X to move';
    renderBoard();
  }

  newBtn.addEventListener('click', resetGame);
  vsAi.addEventListener('change', resetGame);
  diffSel.addEventListener('change', resetGame);
  renderBoard();

  // ===== Doodle Pad =====
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const colorInp = document.getElementById('drawColor');
  const sizeInp  = document.getElementById('drawSize');
  const undoBtn  = document.getElementById('undoDraw');
  const clearBtn = document.getElementById('clearDraw');
  const saveBtn  = document.getElementById('saveDraw');

  function resizeCanvasForDPR(){
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 320;
    const cssH = canvas.clientHeight || 240;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,cssW,cssH);
  }
  canvas.style.width = canvas.width + 'px';
  canvas.style.height = canvas.height + 'px';
  resizeCanvasForDPR();

  let drawing = false, last = null, history = [];
  const MAX_HISTORY = 20;

  function pushHistory(){
    try{
      const img = ctx.getImageData(0,0,canvas.width,canvas.height);
      history.push(img);
      if (history.length > MAX_HISTORY) history.shift();
    }catch(e){}
  }
  function startDraw(pt){ pushHistory(); drawing = true; last = pt; drawTo(pt); }
  function endDraw(){ drawing = false; last = null; }
  function drawTo(pt){
    if (!last){ last = pt; }
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.strokeStyle = colorInp.value; ctx.lineWidth = Number(sizeInp.value);
    ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(pt.x, pt.y); ctx.stroke();
    last = pt;
  }
  function getPoint(e){
    const r = canvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }
  canvas.addEventListener('mousedown', e => { startDraw(getPoint(e)); });
  canvas.addEventListener('mousemove', e => { if(drawing) drawTo(getPoint(e)); });
  window.addEventListener('mouseup', endDraw);
  canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(getPoint(e)); }, {passive:false});
  canvas.addEventListener('touchmove',  e => { e.preventDefault(); if(drawing) drawTo(getPoint(e)); }, {passive:false});
  canvas.addEventListener('touchend',   e => { e.preventDefault(); endDraw(); }, {passive:false});

  undoBtn.addEventListener('click', () => {
    const img = history.pop();
    if (img){
      const dpr = window.devicePixelRatio || 1;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.putImageData(img, 0, 0);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
  });
  clearBtn.addEventListener('click', () => {
    const dpr = window.devicePixelRatio || 1;
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  });
  saveBtn.addEventListener('click', () => {
    const dpr = window.devicePixelRatio || 1;
    ctx.setTransform(1,0,0,1,0,0);
    const link = document.createElement('a');
    link.download = 'doodle.png';
    link.href = canvas.toDataURL('image/png');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    link.click();
  });
  window.addEventListener('orientationchange', () => setTimeout(resizeCanvasForDPR, 250));
})();
</script>
</body>
</html>
